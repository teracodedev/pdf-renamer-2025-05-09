# PDF Renamer

## 概要
PDF Renamer は、PDFファイルの内容を自動的に解析して、適切なファイル名に変更するための強力なツールです。OCR技術と人工知能を組み合わせることで、書類の種類や内容に基づいた一貫性のあるファイル命名を実現します。

## 主な機能
- **AI駆動のファイル命名**: OCR結果とカスタマイズ可能なルールに基づいて、AI（OpenAI）がファイル名を提案
- **柔軟なルールシステム**: YAMLファイルで定義されたルールを使用して、さまざまな種類の書類に対応
- **自動担当者検出**: 書類の内容に基づいて担当者を自動的に判断
- **高速な一括処理**: マルチスレッド処理による効率的なファイル変換
- **洗練されたUI**: 使いやすいグラフィカルインターフェースと進捗表示
- **カスタマイズ可能**: 設定ファイルを通じた柔軟なカスタマイズオプション

## システム要件
- **OS**: Windows 10/11（主にテスト済み）、macOS、Linux（一部機能制限あり）
- **Python**: 3.8以降
- **ディスク容量**: 150MB以上（一時ファイル用）
- **メモリ**: 4GB以上推奨
- **インターネット接続**: Google Cloud VisionとOpenAI APIへのアクセスに必要

## インストール方法

### 1. 依存ライブラリのインストール
```bash
pip install pdf2image google-cloud-vision openai pyyaml python-dotenv
```

### 2. Popplerのインストール
PDFを画像に変換するためにPopplerが必要です。

#### Windows
1. [Poppler for Windows](https://github.com/oschwartz10612/poppler-windows/releases/)から最新版をダウンロード
2. ダウンロードしたZIPファイルを解凍（例: `C:\poppler-24.08.0`）
3. `.env`ファイルの`POPPLER_PATH`に解凍したフォルダ内の`bin`ディレクトリへのパスを設定

#### macOS
```bash
brew install poppler
```

#### Linux (Ubuntu/Debian)
```bash
sudo apt-get install poppler-utils
```

### 3. Google Cloud Vision API設定
1. [Google Cloud Console](https://console.cloud.google.com/)でプロジェクトを作成
2. Vision APIを有効化
3. サービスアカウントキー（JSON）を生成してダウンロード
4. `.env`ファイルの`GOOGLE_APPLICATION_CREDENTIALS`に鍵ファイルのパスを設定

### 4. OpenAI API設定
1. [OpenAI Platform](https://platform.openai.com/)でアカウント作成
2. APIキーを生成
3. `.env`ファイルの`OPENAI_API_KEY`にAPIキーを設定

## 設定ファイル

### `.env`ファイル（基本設定）
アプリケーションと同じディレクトリに`.env`ファイルを作成し、以下のように設定します：

```
# PDFファイルのパス
PDF_FOLDER_PATH=C:/Users/username/Documents/PDFs/

# 一時画像ファイルのパス
IMAGE_FILE_PATH=C:/temp/pdf_images/

# YAMLルールファイルのパス
YAML_FILE=C:/path/to/rename_rules.yaml

# Google Cloud認証情報
GOOGLE_APPLICATION_CREDENTIALS=C:/path/to/google-credentials.json

# OpenAI API Key
OPENAI_API_KEY=your_openai_api_key_here

# Popplerのパス（Windowsの場合）
POPPLER_PATH=C:\poppler-24.08.0\Library\bin

# 担当者のリスト（カンマ区切り）
PERSONS=山田太郎,鈴木花子,佐藤次郎

# デフォルトの担当者
DEFAULT_PERSON=担当者自動設定

# 組織名（オプション）
ORGANIZATION_NAME=株式会社サンプル

# タイトル（オプション）
TITLE=サンプルタイトル
```

### `rename_rules.yaml`（リネームルール）
YAMLファイルには、書類の種類に応じたリネームルールを定義します。各ルールには以下の要素が含まれます：

- **説明**: ルールの説明（内部用）
- **正規表現**: 該当書類を識別するための正規表現パターン
- **書類の種類**: 書類のカテゴリ
- **命名ルール**: ファイル名の基本フォーマット
- **プロンプト**: OpenAI APIに送信するプロンプト
- **優先順位**: ルールの適用優先度（低いほど優先）

サンプル：
```yaml
ファイル命名のルール:
  - ルール:
      説明: '請求書の場合'
      正規表現: '(?i)(請求書|invoice)'
      書類の種類: '請求書'
      命名ルール: '{日付} {取引先}より {内容} 金額{金額}円({担当者})'
      プロンプト: |
        以下のOCR結果は請求書です。命名ルール「{命名ルール}」に従い、適切な情報を抽出してファイル名を生成してください。
        - 日付：OCR結果の中から発行日・請求日を「YYYY年MM月DD日」形式で抽出してください。
        - 取引先：請求元の会社名を抽出してください。
        - 内容：請求内容を簡潔に抽出してください。
        - 金額：請求総額（税込）を数字のみで抽出してください。
        - 担当者：現在の担当者「{担当者}」をそのまま使用してください。
        
        結果は、以下のフォーマットに厳密に従ってください：
        **{日付} {取引先}より {内容} 金額{金額}円({担当者})**
        
        OCR結果: {ocr_result}
      優先順位: 5

  # デフォルトルール（他のルールに一致しない場合）
  - デフォルト:
      説明: 'どのルールにも該当しない場合'
      書類の種類: '不明'
      命名ルール: '{日付} {組織名}より {タイトル}（{担当者}）'
      プロンプト: |
        このファイルの種類は「{書類の種類}」です。命名ルール「{命名ルール}」に従い、適切な情報を抽出してファイル名を生成してください。
        - 日付は「YYYY年MM月DD日」形式で、OCR結果の中で最も適切と思われる日付を使用してください。
        - 組織名はOCR結果の中でこの書類を送ってきた組織と思われる名前を使用してください。
        - タイトルはOCR結果の中で書類の内容を最もよく表す短いフレーズを使用してください。
        - 担当者は「{担当者}」をそのまま使用してください。
        
        結果は、以下のフォーマットに厳密に従ってください：
        **{日付} {組織名}より {タイトル}（{担当者}）**
        
        OCR結果: {ocr_result}
      優先順位: 100
```

## 使用方法

### GUIモード
1. アプリケーションを起動：`python pdf_renamer_pro.py`
2. PDFフォルダを選択（または`.env`ファイルで事前設定）
3. 担当者を選択（または「担当者自動設定」を使用）
4. 「リネーム開始」ボタンをクリック
5. 処理状況と結果が画面に表示されます

### コマンドラインモード（オプション）
```bash
python pdf_renamer_pro.py --folder /path/to/pdfs --person 山田太郎 --silent
```

オプション：
- `--folder`: PDFフォルダのパス
- `--person`: 担当者名
- `--silent`: GUIを表示せずにバックグラウンドで実行

## 高度な機能

### 自動担当者検出
「担当者自動設定」モードでは、書類の内容に基づいて適切な担当者を自動的に判断します。この機能は以下のルールに基づいています：

- 特定のキーワードを検出（例：「翠江会」→「前田至法」）
- 書類に明示的に記載された担当者名を認識
- デフォルト担当者の指定

### バッチ処理の最適化
処理速度と効率を最適化するために、以下の機能が実装されています：

- 並列処理によるマルチスレッド実行
- 一時ファイルの自動クリーンアップ
- エラー処理と再試行メカニズム

### カスタムルールの作成
YAMLファイルを編集することで、独自のリネームルールを作成できます。ルールは正規表現で条件を指定し、OpenAIへのプロンプトでファイル名の生成方法を定義します。

## トラブルシューティング

### 一般的な問題

#### Q: OCRが正しく機能しない
A: 以下を確認してください：
- Google Cloud Visionの認証情報が正しく設定されているか
- プロジェクトで課金が有効になっているか
- PDFが画像ベースであること（テキストレイヤーがない場合はOCRが必要）

#### Q: OpenAIが正しく機能しない
A: 以下を確認してください：
- APIキーが正しく設定されているか
- アカウントの利用制限や課金状況
- インターネット接続が安定しているか

#### Q: PDFの変換に失敗する
A: 以下を確認してください：
- Popplerが正しくインストールされ、パスが設定されているか
- PDFファイルが破損していないか
- 十分なディスク容量があるか

### ログファイル
問題のトラブルシューティングには、アプリケーションと同じディレクトリに生成される`pdf_renamer.log`ファイルを確認してください。

## API制限とコスト
このアプリケーションは外部APIを使用し、使用量に応じた料金が発生する場合があります：

- **Google Cloud Vision API**: 1000リクエストあたり約$1.50
- **OpenAI API**: 使用モデルと使用量に応じて課金

課金を管理するために、処理するPDFファイルの数と頻度を考慮してください。

## セキュリティ上の注意
- API認証情報（`.env`ファイル）を安全に保管し、バージョン管理システムにコミットしないでください
- 機密文書を処理する場合は、データプライバシーポリシーを確認してください
- アプリケーションを定期的に更新して、セキュリティパッチを適用してください

## ライセンス
このソフトウェアはMIT Licenseの下で提供されています。詳細はLICENSEファイルを参照してください。

## 謝辞
このプロジェクトは以下のオープンソースライブラリを使用しています：
- pdf2image
- google-cloud-vision
- openai
- pyyaml
- python-dotenv
- tkinter

## 更新履歴

### v2.0.0 (2025-05-09)
- コードベースの完全リファクタリング
- 改善されたGUIインターフェース
- 強化されたエラー処理とロギング
- 強化された担当者自動検出アルゴリズム
- 多言語OCRサポート
- パフォーマンス最適化

### v1.0.0 (2024-01-22)
- 初回リリース

## 今後の開発予定
- クラウド同期機能
- バッチ処理のスケジューリング
- 機械学習モデルの統合によるより高度な文書分類
- テンプレートベースのPDF生成機能

## 開発者向け情報

### プロジェクト構造
```
pdf-renamer/
├── pdf_renamer.py   # メインアプリケーション
├── .env                 # 環境設定ファイル
├── rename_rules.yaml    # リネームルール定義
├── LICENSE              # ライセンスファイル
├── README.md            # このファイル
└── logs/                # ログファイル
```

### 拡張とカスタマイズ
開発者の方は、このプロジェクトを以下の方法で拡張できます：

1. **新しいOCRエンジンの追加**：
   ```python
   class CustomOCRProvider:
       def extract_text(self, image_path):
           # 実装
           return text
   ```

2. **新しいAIプロバイダーの追加**：
   ```python
   class CustomAIProvider:
       def generate_filename(self, ocr_text, prompt):
           # 実装
           return filename
   ```

3. **カスタムUIテーマ**：
   ```python
   def apply_custom_theme(root):
       # テーマ設定の実装
       pass
   ```

### テスト
テストを実行するには：
```bash
python -m unittest discover tests
```

## コントリビューション
バグレポートや機能リクエスト、プルリクエストを歓迎します。
コントリビューションの前に、issue を作成して変更内容について議論することをお勧めします。

---

*このプロジェクトは、ドキュメント管理の自動化と効率化を目的として開発されました。*